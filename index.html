<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMARS AI è’¸é¤¾å™¨ (BYOK/BYOB)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #f4f7f9; color: #333; }
        .container { max-width: 900px; margin: auto; background-color: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { color: #007bff; text-align: center; margin-bottom: 25px; }
        label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600; }
        input[type="text"], textarea, select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { background-color: #28a745; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #218838; }
        #output { margin-top: 30px; padding: 15px; border: 1px dashed #007bff; border-radius: 5px; background-color: #e9f7ff; }
        pre { white-space: pre-wrap; word-wrap: break-word; background-color: #eee; padding: 10px; border-radius: 4px; border: 1px solid #ddd; }
        .log-item { margin-bottom: 10px; padding: 8px; border-left: 3px solid #007bff; background-color: #f8f8f8; }
        .log-item.Error { border-left-color: #dc3545; background-color: #ffe0e3; }
        .log-item-title { font-weight: bold; color: #007bff; }
        .log-item.Error .log-item-title { color: #dc3545; }
        #loading { display: none; color: #007bff; font-weight: bold; margin-top: 20px; }
        .key-input-group { display: flex; align-items: center; margin-bottom: 10px; }
        .key-input-group select { width: 30%; margin-right: 10px; padding: 10px; border-radius: 5px; }
        .key-input-group input { flex-grow: 1; }
        .note { font-size: 0.9em; color: #666; margin-top: 5px;}
    </style>
</head>
<body>

<div class="container">
    <h1>IMARS AI è’¸é¤¾å™¨ (BYOK/BYOB)</h1>
    <p class="note">æ­¤ä»‹é¢å…è¨±æ‚¨æŒ‡å®šå¾Œç«¯ URLï¼Œä¸¦æä¾›å¤šå€‹ä¸åŒä¾›æ‡‰å•†çš„ API Key é€²è¡Œè’¸é¤¾ã€‚</p>

    <form id="distillationForm">
        
        <label for="apiUrl">å¾Œç«¯ API URL (BYOB æœå‹™åœ°å€):</label>
        <input type="text" id="apiUrl" value="https://imars-ai-distiller.onrender.com/api/distill" required>
        <p class="note">ğŸ’¡ é è¨­ç‚ºæ‚¨éƒ¨ç½²çš„ Render æœå‹™åœ°å€ã€‚æ‚¨å¯ä»¥æ›¿æ›ç‚ºä»»ä½•éµå¾ªç›¸åŒ API è¦ç¯„çš„ä¼ºæœå™¨ã€‚</p>

        <label>ğŸ” æ‚¨çš„ Key Pool (æœ€å¤š 10 å€‹ Key):</label>
        <p class="note" style="color:#cc3300;">âš ï¸ Key è²»ç”¨å°‡ç”±æ‚¨èˆ‡ä¾›æ‡‰å•†çµç®—ã€‚è«‹å¡«å¯«è‡³å°‘ä¸€å€‹ Keyã€‚</p>
        
        <div id="keyPoolContainer">
            </div>
        <button type="button" onclick="addKeyInput()">+ æ–°å¢ Key</button>

        <label for="prompt" style="margin-top: 20px;">ç”¨æˆ¶æç¤º (Prompt):</label>
        <textarea id="prompt" rows="5" required>AI æ¨¡å‹è’¸é¤¾çš„æ ¸å¿ƒåŸç†æ˜¯ä»€éº¼ï¼Ÿè«‹è©³ç´°è§£é‡‹ã€Œè»Ÿæ¨™ç±¤ã€å’Œã€Œç¡¬æ¨™ç±¤ã€çš„å·®ç•°ã€‚</textarea>

        <button type="submit">å•Ÿå‹• AI è’¸é¤¾</button>
    </form>
    
    <div id="loading">... æ­£åœ¨é€²è¡Œå¤šä»£ç†è¿­ä»£ç²¾ç…‰ï¼Œè«‹ç¨å€™ ...</div>

    <div id="output">
        <h2>è™•ç†çµæœ</h2>
        
        <label>æœ€çµ‚ç²¾ç…‰ç­”æ¡ˆ (Final Answer):</label>
        <pre id="finalAnswer">å°šæœªåŸ·è¡Œã€‚</pre>
        
        <label>æµç¨‹æ—¥èªŒ (Process Log):</label>
        <div id="processLog">ç„¡æ—¥èªŒã€‚</div>
    </div>
</div>

<script>
    const MAX_KEYS = 10;
    const keyPoolContainer = document.getElementById('keyPoolContainer');
    let keyCount = 0;

    // åˆå§‹åŒ–ï¼šé è¨­é¡¯ç¤º 3 å€‹ Key è¼¸å…¥æ¡†
    window.onload = function() {
        for (let i = 0; i < 3; i++) {
            addKeyInput();
        }
    }

    /**
     * å‹•æ…‹æ–°å¢ Key å’Œ Vendor è¼¸å…¥æ¡†
     */
    function addKeyInput() {
        if (keyCount >= MAX_KEYS) {
            alert(`æœ€å¤šåªèƒ½æ·»åŠ  ${MAX_KEYS} å€‹ Keyã€‚`);
            return;
        }

        keyCount++;
        
        const div = document.createElement('div');
        div.className = 'key-input-group';
        div.id = `key-group-${keyCount}`;

        const vendorSelect = document.createElement('select');
        vendorSelect.name = 'vendor';
        vendorSelect.innerHTML = `
            <option value="gemini">Google Gemini</option>
            <option value="openai">OpenAI</option>
            <option value="deepseek">DeepSeek AI</option>
            <option value="">-- å…¶ä»– --</option>
        `;

        const keyInput = document.createElement('input');
        keyInput.type = 'text';
        keyInput.name = 'key';
        keyInput.placeholder = `Key #${keyCount} (ä¾‹å¦‚: AIzaSy...æˆ– sk-...)`;

        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.textContent = 'X';
        removeButton.style.width = '30px';
        removeButton.style.marginLeft = '10px';
        removeButton.style.backgroundColor = '#dc3545';
        removeButton.onclick = function() {
            keyPoolContainer.removeChild(div);
            keyCount--;
        };

        div.appendChild(vendorSelect);
        div.appendChild(keyInput);
        div.appendChild(removeButton);
        keyPoolContainer.appendChild(div);
    }


    document.getElementById('distillationForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        // 1. ç²å–è¼¸å…¥å€¼
        const apiUrl = document.getElementById('apiUrl').value.trim();
        const prompt = document.getElementById('prompt').value;

        // 2. æ§‹é€  Key Pool
        const apiKeysPool = [];
        const keyGroups = keyPoolContainer.querySelectorAll('.key-input-group');
        
        keyGroups.forEach(group => {
            const vendor = group.querySelector('select[name="vendor"]').value.trim();
            const key = group.querySelector('input[name="key"]').value.trim();
            
            if (key && vendor) {
                apiKeysPool.push({ vendor: vendor.toLowerCase(), key: key });
            }
        });

        if (apiKeysPool.length === 0) {
            alert("è«‹è‡³å°‘å¡«å¯«ä¸€å€‹æœ‰æ•ˆçš„ Key å’Œä¾›æ‡‰å•†!");
            return;
        }


        // 3. æº–å‚™è¼¸å‡ºå…ƒç´ 
        const finalAnswerElement = document.getElementById('finalAnswer');
        const processLogElement = document.getElementById('processLog');
        const loadingElement = document.getElementById('loading');
        
        finalAnswerElement.textContent = 'è™•ç†ä¸­...';
        processLogElement.innerHTML = '';
        loadingElement.style.display = 'block';

        const requestBody = {
            prompt: prompt,
            api_keys_pool: apiKeysPool // åŒ¹é…å¾Œç«¯æœŸæœ›çš„æ–°çµæ§‹
        };

        try {
            // 4. ç™¼é€è«‹æ±‚
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();

            // 5. è™•ç†çµæœ
            if (response.ok && data.success) {
                finalAnswerElement.textContent = data.final_answer || 'æœªèƒ½ç”¢ç”Ÿç­”æ¡ˆã€‚';
            } else {
                finalAnswerElement.textContent = `ğŸš¨ éŒ¯èª¤ (${response.status} ${response.statusText}): ${data.error || 'å¾Œç«¯ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤'}`;
                // å³ä½¿å¤±æ•—ï¼Œä¹Ÿå˜—è©¦é¡¯ç¤ºæ—¥èªŒ
                renderLog(data.log || [], processLogElement);
                return;
            }

            // 6. æ¸²æŸ“æ—¥èªŒ
            renderLog(data.log, processLogElement);

        } catch (error) {
            // é€™å€‹éŒ¯èª¤é€šå¸¸æ˜¯å› ç‚º CORS é™åˆ¶æˆ– URL éŒ¯èª¤
            finalAnswerElement.textContent = `é€£æ¥éŒ¯èª¤: ç„¡æ³•é€£æ¥åˆ°æœå‹™ã€‚è«‹æª¢æŸ¥ URL æˆ– CORS é™åˆ¶ã€‚éŒ¯èª¤è¨Šæ¯: ${error.message}`;
            processLogElement.innerHTML = '';
        } finally {
            loadingElement.style.display = 'none';
        }
    });

    /**
     * å°‡å¾Œç«¯è¿”å›çš„æ—¥èªŒé™£åˆ—æ¸²æŸ“åˆ° HTML ä¸­
     */
    function renderLog(logArray, targetElement) {
        targetElement.innerHTML = '';
        if (!logArray || logArray.length === 0) {
            targetElement.innerHTML = 'ç„¡è©³ç´°è™•ç†æ—¥èªŒã€‚';
            return;
        }
        
        logArray.forEach(item => {
            const div = document.createElement('div');
            div.className = `log-item ${item.type}`; 
            
            const title = document.createElement('div');
            title.className = 'log-item-title';
            title.textContent = item.title;
            
            const content = document.createElement('pre');
            content.textContent = item.content; 
            
            div.appendChild(title);
            div.appendChild(content);
            targetElement.appendChild(div);
        });
    }
</script>

</body>
</html>
